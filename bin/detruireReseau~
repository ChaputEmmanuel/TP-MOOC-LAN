#!/bin/bash

VERBOSE=True

BASEDIR=$PWD
BRCTL=/sbin/brctl
IP=/sbin/ip
KILL=/bin/kill
MKFIFO=/usr/bin/mkfifo
MKDIR=/bin/mkdir
RM=/bin/rm
TOUCH=/usr/bin/touch
TRUE=/bin/true

if [ $UID != 0 ] ; then
   echo "T'es pas root, tu passes ta route, ..."
   exit
fi

LABCONF=$BASEDIR/lab.conf
LABSTARTUP=$BASEDIR/lab.startup

if [ $VERBOSE == True ] ; then
  echo "* Chargement du fichier de configuration"
fi

if [ -f $LABCONF ] ; then 
   . $LABCONF
fi

if [ $VERBOSE == True ] ; then
   echo "* Fermeture des consoles"
fi
if [ -f .console-pids ] ; then 
   for c in `cat .console-pids`
   do
       $KILL $c
   done
   $RM .console-pids
fi

if [ -f .tcpdump-pids ] ; then 
   if [ $VERBOSE == True ] ; then
      echo "* Fermeture des tcpdump"
   fi
   for c in `cat .tcpdump-pids`
   do
       $KILL $c
   done
   $RM .tcpdump-pids
fi

# Destruction des liens
#======================
IFLIST=""
for l in $LINKS
do
   if [ $VERBOSE == True ] ; then
       echo "    Shutting down ink $l ..."
   fi

   # Parsing source
   #---------------
   src=`echo $l| cut -d! -f1`
   srch=`echo $src|cut -d: -f1`
   if [ -z "$srch" ] ; then
      echo "*** No source host defined in '$l'"
      exit
   fi
   srcIsBr=no
   if [ -z "`$IP netns list|grep $srch`" ] ; then
       for br in $BRIDGES
       do
	   if [ $br == $srch ] ; then
               if [ $VERBOSE == True ] ; then
	           echo "       $srch is a bridge"
	       fi
	       srcIsBr=yes
	   fi
       done
       if [ "$srcIsBr" == "no" ] ; then
	   echo "*** Unknown host '$srch'"
	   exit
       fi
   fi
   srci=`echo $src|cut -d: -f2`
   if [ -z "$srci" ] ; then
      echo "*** No source interface defined in '$l'"
      exit
   fi
   IFLIST="$IFLIST $srch:$srci"
   srca=`echo $src|cut -d: -f3`

   # Parsing destination
   #--------------------
   dst=`echo $l| cut -d! -f2`
   dsth=`echo $dst|cut -d: -f1`
   if [ -z "$dsth" ] ; then
      echo "*** No destination host defined in '$l'"
      exit
   fi
   dstIsBr=no
   if [ -z "`$IP netns list|grep $dsth`" ] ; then
       for br in $BRIDGES
       do
	   if [ $br == $dsth ] ; then
               if [ $VERBOSE == True ] ; then
	           echo "       Dst is a bridge"
	       fi
	       dstIsBr=yes
	   fi
       done
       if [ "$dstIsBr" == "no" ] ; then
	   echo "*** Unknown host '$dsth'"
	   exit
       fi
   fi
   dsti=`echo $dst|cut -d: -f2`
   if [ -z ""$dsti -a "$dstIsBr" == "no" ] ; then
      echo "*** No destination interface defined in '$l'"
      exit
   fi
   IFLIST="$IFLIST $dsth:$dsti"
   dsta=`echo $dst|cut -d: -f3`
   if [ $VERBOSE == True ] ; then
       echo "       $srch ($srci)  <-> $dsth ($dsti)"
       if [ -n "$srca" ] ; then
	   echo "       $srch : $srca"
       fi   
       if [ -n "$dsta" ] ; then
	   echo "       $dsth : $dsta"
       fi   
   fi

   # I only build links where dstIsBr or !srcIsBr
   #---------------------------------------------
   if [ "$srcIsBr" == "yes" -a "$dstIsBr" == "no" ] ; then
      echo "** Forbiden bridge to host link : $l"
   fi

   if [ "$dstIsBr" == "no" ] ; then
      $IP netns exec $srch $IP link set $srci down > /dev/null 2>&1 ||$TRUE
      $IP netns exec $srch $IP link del $srci > /dev/null 2>&1 ||$TRUE
      $IP netns exec $dsth $IP link set $dsti down > /dev/null 2>&1 ||$TRUE
      $IP netns exec $dsth $IP link del $dsti > /dev/null 2>&1 ||$TRUE
   else
      if [ "$srcIsBr" == "no" ] ; then
          $IP netns exec $srch $IP link set $srci down > /dev/null 2>&1 ||$TRUE
          $IP netns exec $srch $IP link del $srci > /dev/null 2>&1 ||$TRUE
      else
          $IP link set $srch.$srci down > /dev/null 2>&1 ||$TRUE
          $BRCTL delif $srch $srch.$srci > /dev/null 2>&1 ||$TRUE
          $IP link del $srch.$srci > /dev/null 2>&1 ||$TRUE
      fi
      $IP link set $dsth.$dsti down > /dev/null 2>&1 ||$TRUE
      $BRCTL delif $dsth $dsth.$dsti > /dev/null 2>&1 ||$TRUE
      $IP link del $dsth.$dsti > /dev/null 2>&1 ||$TRUE
   fi
done

# Arret des machines
#===================
if [ $VERBOSE == True ] ; then
   echo "* Arret des machines"
fi
for h in $HOSTS
do
   if [ $VERBOSE == True ] ; then
      echo -n "    $h : "
   fi
   
   $IP netns del $h > /dev/null 2>&1 ||$TRUE

   if [ $VERBOSE == True ] ; then
      echo "ok"
   fi
done

# Destruction des ponts
#======================
if [ $VERBOSE == True ] ; then
   echo "* Arret des ponts"
fi
for b in $BRIDGES
do
    if [ $VERBOSE == True ] ; then
	echo "    Désactivation de $b"
    fi
    $IP link set $b down
    if [ $VERBOSE == True ] ; then
	echo "    Destruction de $b"
    fi
    $BRCTL delbr $b
done
